var PL={NV_P_FORMAT:"p_format=xml-strict",NV_P_MODE:"p_mode=pull",pushletURL:null,webRoot:null,sessionId:null,STATE_ERROR:-2,STATE_ABORT:-1,STATE_NULL:1,STATE_READY:2,STATE_JOINED:3,STATE_LISTENING:3,state:1,heartbeat:function(){PL._doRequest("hb");
},join:function(){PL.sessionId=null;
PL._doRequest("join",PL.NV_P_FORMAT+"&"+PL.NV_P_MODE);
},joinListen:function(b){PL._setStatus("join-listen "+b);
PL.sessionId=null;
var a=PL.NV_P_FORMAT+"&"+PL.NV_P_MODE;
if(b){a=a+"&p_subject="+b;
}PL._doRequest("join-listen",a);
},leave:function(){PL._doRequest("leave");
},listen:function(b){var a=PL.NV_P_MODE;
if(b){a=a+"&p_subject="+b;
}PL._doRequest("listen",a);
},publish:function(c,a){var b="p_subject="+c;
if(a){b=b+"&"+a;
}PL._doRequest("publish",b);
},subscribe:function(c,a){var b="p_subject="+c;
if(a){b=b+"&p_label="+a;
}PL._doRequest("subscribe",b);
},unsubscribe:function(a){var b;
if(a){b="p_sid="+a;
}PL._doRequest("unsubscribe",b);
},setDebug:function(a){PL.debugOn=a;
},_addEvent:function(f,c,e,a){var d=PL._getObject(f);
if(d.addEventListener){d.addEventListener(c,e,a);
return true;
}else{if(d.attachEvent){var b=d.attachEvent("on"+c,e);
return b;
}else{d["on"+c]=e;
}}},_doCallback:function(b,a){if(a){a(b);
}else{if(window.onEvent){onEvent(b);
}}},_doRequest:function(a,d){if(PL.state<0){PL._setStatus("died ("+PL.state+")");
return;
}var c=false;
if(a=="join"||a=="join-listen"){c=(PL.state<PL.STATE_READY);
}else{if(a=="leave"){PL.state=PL.STATE_READY;
}else{if(a=="refresh"){if(PL.state!=PL.STATE_LISTENING){return;
}}else{if(a=="listen"){c=(PL.state<PL.STATE_JOINED);
}else{if(a=="subscribe"||a=="unsubscribe"){c=(PL.state<PL.STATE_LISTENING);
}else{c=(PL.state<PL.STATE_JOINED);
}}}}}if(c==true){PL._setStatus(a+" , waiting... state="+PL.state);
setTimeout(function(){PL._doRequest(a,d);
},100);
return;
}var b=PL.pushletURL+"?p_event="+a;
if(d){b=b+"&"+d;
}if(PL.sessionId!=null){b=b+"&p_id="+PL.sessionId;
if(a=="p_leave"){PL.sessionId=null;
}}PL.debug("_doRequest",b);
PL._getXML(b,PL._onResponse);
},_getObject:function(a){if(typeof a=="string"){return document.getElementById(a);
}else{return a;
}},_getWebRoot:function(){if(PL.webRoot!=null){return PL.webRoot;
}var d=document.getElementsByTagName("head")[0];
var a=d.childNodes;
for(var c=0;
c<a.length;
++c){var e=a.item(c).src;
if(e){var b=e.indexOf("pl-client.min.js");
if(b>=0){b=e.indexOf("scripts");
PL.webRoot=e.substring(0,b);
break;
}}}return PL.webRoot;
},_getXML:function(b,f){var c=new XMLHttpRequest();
if(!c||c==null){alert("No browser XMLHttpRequest (AJAX) support");
return;
}var a=f;
var d=false;
if(a){d=true;
c.onreadystatechange=function(){if(c.readyState==4){if(c.status==200){a(c.responseXML);
c=null;
}else{var g=new PushletEvent();
g.put("p_event","error");
g.put("p_reason","[pushlet] problem retrieving XML data:\n"+c.statusText);
PL._onEvent(g);
}}};
}c.open("GET",b,d);
c.send(null);
if(!a){if(c.status!=200){var e=new PushletEvent();
e.put("p_event","error");
e.put("p_reason","[pushlet] problem retrieving XML data:\n"+c.statusText);
PL._onEvent(e);
return null;
}return c.responseXML;
}},_init:function(){PL._showStatus();
PL._setStatus("initializing...");
if(window.ActiveXObject&&!window.XMLHttpRequest){window.XMLHttpRequest=function(){var c=new Array("Msxml2.XMLHTTP.5.0","Msxml2.XMLHTTP.4.0","Msxml2.XMLHTTP.3.0","Msxml2.XMLHTTP","Microsoft.XMLHTTP");
for(var a=0;
a<c.length;
a++){try{return new ActiveXObject(c[a]);
}catch(b){}}return null;
};
}if(!window.ActiveXObject&&window.XMLHttpRequest){window.ActiveXObject=function(a){switch(a.toLowerCase()){case"microsoft.xmlhttp":case"msxml2.xmlhttp":case"msxml2.xmlhttp.3.0":case"msxml2.xmlhttp.4.0":case"msxml2.xmlhttp.5.0":return new XMLHttpRequest();
}return null;
};
}PL.pushletURL=PL._getWebRoot()+"pushlet.srv";
PL._setStatus("initialized");
PL.state=PL.STATE_READY;
},_onEvent:function(b){PL.debug("_onEvent()",b.toString());
var a=b.getEvent();
if(a=="data"){PL._setStatus("data");
PL._doCallback(b,window.onData);
}else{if(a=="refresh"){if(PL.state<PL.STATE_LISTENING){PL._setStatus("not refreshing state="+PL.STATE_LISTENING);
}var d=b.get("p_wait");
var c=PL.state;
setTimeout(function(){PL.state=c;
PL._doRequest("refresh");
},d);
return;
}else{if(a=="error"){PL.state=PL.STATE_ERROR;
PL._setStatus("server error: "+b.get("p_reason"));
PL._doCallback(b,window.onError);
}else{if(a=="join-ack"){PL.state=PL.STATE_JOINED;
PL.sessionId=b.get("p_id");
PL._setStatus("connected");
PL._doCallback(b,window.onJoinAck);
}else{if(a=="join-listen-ack"){PL.state=PL.STATE_LISTENING;
PL.sessionId=b.get("p_id");
PL._setStatus("join-listen-ack");
PL._doCallback(b,window.onJoinListenAck);
}else{if(a=="listen-ack"){PL.state=PL.STATE_LISTENING;
PL._setStatus("listening");
PL._doCallback(b,window.onListenAck);
}else{if(a=="hb"){PL._setStatus("heartbeat");
PL._doCallback(b,window.onHeartbeat);
}else{if(a=="hb-ack"){PL._doCallback(b,window.onHeartbeatAck);
}else{if(a=="leave-ack"){PL._setStatus("disconnected");
PL._doCallback(b,window.onLeaveAck);
}else{if(a=="refresh-ack"){PL._doCallback(b,window.onRefreshAck);
}else{if(a=="subscribe-ack"){PL._setStatus("subscribed to "+b.get("p_subject"));
PL._doCallback(b,window.onSubscribeAck);
}else{if(a=="unsubscribe-ack"){PL._setStatus("unsubscribed");
PL._doCallback(b,window.onUnsubscribeAck);
}else{if(a=="abort"){PL.state=PL.STATE_ERROR;
PL._setStatus("abort");
PL._doCallback(b,window.onAbort);
}else{if(a.match(/nack$/)){PL._setStatus("error response: "+b.get("p_reason"));
PL._doCallback(b,window.onNack);
}}}}}}}}}}}}}}},_onResponse:function(a){PL.debug("_onResponse",a);
var b=PL._rsp2Events(a);
if(b==null){PL._setStatus("null events");
return;
}delete a;
PL.debug("_onResponse eventCnt=",b.length);
for(i=0;
i<b.length;
i++){PL._onEvent(b[i]);
}},_rsp2Events:function(a){if(!a||!a.documentElement){return null;
}var c=a.documentElement.getElementsByTagName("event");
var b=new Array(c.length);
for(i=0;
i<c.length;
i++){b[i]=new PushletEvent(c[i]);
}return b;
},statusMsg:"null",statusChanged:false,statusChar:"|",_showStatus:function(){if(PL.statusChanged==true){if(PL.statusChar=="|"){PL.statusChar="/";
}else{if(PL.statusChar=="/"){PL.statusChar="--";
}else{if(PL.statusChar=="--"){PL.statusChar="\\";
}else{PL.statusChar="|";
}}}PL.statusChanged=false;
}window.defaultStatus=PL.statusMsg;
window.status=PL.statusMsg+"  "+PL.statusChar;
timeout=window.setTimeout("PL._showStatus()",400);
},_setStatus:function(a){PL.statusMsg="pushlet - "+a;
PL.statusChanged=true;
},timestamp:0,debugWindow:null,messages:new Array(),messagesIndex:0,debugOn:false,debug:function(c,e){if(PL.debugOn==false){return;
}var f="none";
if(PL.debug.caller){f=PL.debug.caller.toString();
f=f.substring(9,f.indexOf(")")+1);
}var g="-"+f+": "+c+"="+e;
var b=new Date();
var a=b-PL.timestamp;
if(a<10000){g+=" ("+a+" msec)";
}PL.timestamp=b;
if((PL.debugWindow==null)||PL.debugWindow.closed){PL.debugWindow=window.open("","p_debugWin","toolbar=no,scrollbars=yes,resizable=yes,width=600,height=400");
}PL.messages[PL.messagesIndex++]=g;
PL.debugWindow.document.writeln("<html><head><title>Pushlet Debug Window</title></head><body bgcolor=#DDDDDD>");
for(var d=0;
d<PL.messagesIndex;
d++){PL.debugWindow.document.writeln("<pre>"+d+": "+PL.messages[d]+"</pre>");
}PL.debugWindow.document.writeln("</body></html>");
PL.debugWindow.document.close();
PL.debugWindow.focus();
}};
function PushletEvent(a){this.arr=new Array();
this.getSubject=function(){return this.get("p_subject");
};
this.getEvent=function(){return this.get("p_event");
};
this.put=function(c,d){return this.arr[c]=d;
};
this.get=function(c){return this.arr[c];
};
this.toString=function(){var d="";
for(var c in this.arr){d=d+c+"="+this.arr[c]+"\n";
}return d;
};
this.toTable=function(){var d='<table border="1" cellpadding="3">';
var e='<div style="color:black; font-family:monospace; font-size:10pt; white-space:pre;">';
for(var c in this.arr){d=d+"<tr><td bgColor=white>"+e+c+"</div></td><td bgColor=white>"+e+this.arr[c]+"</div></td></tr>";
}d+="</table>";
return d;
};
if(a){for(var b=0;
b<a.attributes.length;
b++){this.put(a.attributes[b].name,a.attributes[b].value);
}}}function p_debug(c,b,a){if(c==false){return;
}PL.setDebug(true);
PL.debug(b,a);
PL.setDebug(false);
}function p_embed(a){alert("Pushlet: p_embed() is no longer required for AJAX client");
}function p_join(){PL.join();
}function p_listen(b,a){PL.listen(b);
}function p_join_listen(a){PL.joinListen(a);
}function p_leave(){PL.leave();
}function p_heartbeat(){PL.heartbeat();
}function p_publish(f,a){var c=p_publish.arguments;
var e="";
var b="";
for(var d=1;
d<c.length;
d++){if(d>1){b="&";
}e=e+b+c[d]+"="+c[++d];
}PL.publish(f,e);
}function p_subscribe(b,a){PL.subscribe(b,a);
}function p_unsubscribe(a){PL.unsubscribe(a);
}PL._addEvent(window,"load",PL._init,false);
